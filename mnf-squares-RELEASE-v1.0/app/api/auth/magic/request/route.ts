import { NextResponse } from 'next/server'; import { PrismaClient } from '@prisma/client'; import { randomUUID } from 'crypto'; import { sendMail } from '@/app/lib/mail'; const prisma=new PrismaClient(); export async function POST(req:Request){ const { email, redirect } = await req.json(); if(!email) return NextResponse.json({ error:'email required' }, { status:400 }); const token=randomUUID().replace(/-/g,''); const expiresAt=new Date(Date.now()+15*60*1000); await prisma.magicLinkToken.create({ data:{ email, token, expiresAt } }); const base=process.env.APP_BASE_URL||'http://localhost:3000'; const url=`${base}/api/auth/magic/verify?token=${token}${redirect?`&redirect=${encodeURIComponent(redirect)}`:''}`; try{ await sendMail(email,'Your MNF Squares magic link',`Click to sign in: ${url}\nThis link expires in 15 minutes.`);}catch{} return NextResponse.json({ ok:true }); }